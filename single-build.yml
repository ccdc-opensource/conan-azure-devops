parameters:
  - name: conan.python
    type: string
    default: $(conan.python)
  - name: conan.package
    type: string
    default: $(conan.package)
  - name: conan.package_version
    type: string
    default: $(conan.python)
  - name: conan.user
    type: string
    default: $(conan.user)
  - name: conan.channel
    type: string
    default: $(conan.channel)
  - name: conan.profile
    type: string
    default: $(conan.profile)
  - name: conan.build_types
    type: object
    default:
    - Release
    - Debug
    - RelWithDebInfo

steps:
- script: ${{ parameters.conan.python }} -m pip install --upgrade conan
  displayName: 'Install conan'

- task: ArtifactoryGenericDownload@3
  displayName: 'Download configuration'
  inputs:
    connection: 'devops-ccdc-3rd-party'
    specSource: 'taskConfiguration'
    fileSpec: |
      {
        "files": [
          {
            "pattern": "ccdc-conan-metadata/common-3rdparty-config.zip",
            "target": "$(Pipeline.Workspace)/.conan/"
          }
        ]
      }
    failNoOp: true

- task: ArtifactoryConan@1
  displayName: 'Install configuration'
  inputs:
    conanCommand: 'Config Install'
    configSourceType: 'zip'
    configZipPath: '$(Pipeline.Workspace)/.conan/common-3rdparty-config.zip'
    conanUserHome: '$(Pipeline.Workspace)/.conan'

- task: ArtifactoryConan@1
  displayName: 'Use ccdc-3rdparty-conan-mix'
  inputs:
    conanCommand: 'Add Remote'
    remoteName: 'ccdc-3rdparty-conan-mix'
    artifactoryService: 'devops-ccdc-3rd-party'
    conanRepo: 'ccdc-3rdparty-conan-mix'
    purgeExistingRemotes: true
    conanUserHome: '$(Pipeline.Workspace)/.conan'

- task: ArtifactoryConan@1
  displayName: 'Install ${{ parameters.conan.package }}/${{ parameters.conan.package_version }}@'
  inputs:
    conanCommand: 'Install'
    pathOrReference: '${{ parameters.conan.package }}/${{ parameters.conan.package_version }}@'
    buildName: '$(Build.DefinitionName)'
    buildNumber: '$(Build.BuildNumber)'
    conanUserHome: '$(Pipeline.Workspace)/.conan'
    
- task: ArtifactoryConan@1
  displayName: 'Copy to ${{ parameters.conan.user }}/${{ parameters.conan.channel }}'
  inputs:
    conanCommand: 'Custom'
    customArguments: 'copy ${{ parameters.conan.package }}/${{ parameters.conan.package_version }} ${{ parameters.conan.user }}/${{ parameters.conan.channel }}'
    buildName: '$(Build.DefinitionName)'
    buildNumber: '$(Build.BuildNumber)'
    conanUserHome: '$(Pipeline.Workspace)/.conan'

- ${{ each build_type in parameters.conan.build_types }}: # Each build_type
  - task: ArtifactoryConan@1
    displayName: 'Build ${{ parameters.conan.package }} in ${{ parameters.build_type }} mode'
    inputs:
      conanCommand: 'Install'
      pathOrReference: '${{ parameters.conan.package }}/${{ parameters.conan.package_version }}@${{ parameters.conan.user }}/${{ parameters.conan.channel }}'
      # We build a single package, on purpose, dependencies must be tracked
      extraArguments: '--profile ${{ parameters.conan.profile }} --build=${{ parameters.conan.package }} -s build_type=${{ parameters.build_type }}'
      buildName: '$(Build.DefinitionName)'
      buildNumber: '$(Build.BuildNumber)'
      conanUserHome: '$(Pipeline.Workspace)/.conan'

- task: ArtifactoryConan@1
  displayName: 'Upload ${{ parameters.conan.package }}/${{ parameters.conan.package_version }}@${{ parameters.conan.user }}/${{ parameters.conan.channel }}'
  inputs:
    conanCommand: 'Upload'
    patternOrReference: '${{ parameters.conan.package }}/${{ parameters.conan.package_version }}@${{ parameters.conan.user }}/${{ parameters.conan.channel }}'
    extraArguments: '--all'
    buildName: '$(Build.DefinitionName)'
    buildNumber: '$(Build.BuildNumber)'
    conanUserHome: '$(Pipeline.Workspace)/.conan'

